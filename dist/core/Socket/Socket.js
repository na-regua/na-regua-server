'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};Object.defineProperty(exports,'__esModule',{value:true});exports.SocketServer=void 0;const modules_1=require('../../api/modules');const socket_io_1=require('socket.io');const __1=require('..');const events_1=require('./events');class SocketServer{constructor(app){this.app=app;}start(){this.io=new socket_io_1.Server(this.app,{cors:{origin:'*'}});this.io.engine.use(__1.sessionMiddleware);this.io.engine.use((req,res,next)=>__awaiter(this,void 0,void 0,function*(){const isHandshake=req._query.sid===undefined;if(!isHandshake){return next();}let token=req.headers.authorization;if(!token){return next(new __1.HttpException(403,__1.SYSTEM_ERRORS.TOKEN_NOT_FOUND));}token=token.replace('Bearer','').trim();const user=yield modules_1.UsersModel.findByToken(token);yield user.populate('avatar');if(!user){return next(new __1.HttpException(400,__1.SYSTEM_ERRORS.UNAUTHORIZED));}req.session.user=user;req.session.save();next();}));this.onConnection();}onConnection(){this.io.on('connection',socket=>{const user=socket.request.session.user;const queueEvents=new events_1.SocketQueueEvents(socket,user);queueEvents.init();socket.join(user._id.toString());socket.on('disconnect',()=>{socket.leave(user._id.toString());});});}emitEvent(socket,event,data){const eventData={event,data};socket.emit(__1.SocketUrls.Event,eventData);}emitGlobalEvent(room,event,data){const eventData={event,data};this.io.to(room).emit(__1.SocketUrls.Event,eventData);}}exports.SocketServer=SocketServer;